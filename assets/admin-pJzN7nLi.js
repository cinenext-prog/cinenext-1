import"./modulepreload-polyfill-B5Qt9EMX.js";const D="modulepreload",F=function(e){return"/cinenext-1/"+e},K={},J=function(t,n,o){let r=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),c=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));r=Promise.allSettled(n.map(s=>{if(s=F(s),s in K)return;K[s]=!0;const m=s.endsWith(".css"),u=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${s}"]${u}`))return;const d=document.createElement("link");if(d.rel=m?"stylesheet":D,m||(d.as="script"),d.crossOrigin="",d.href=s,c&&d.setAttribute("nonce",c),document.head.appendChild(d),m)return new Promise((w,R)=>{d.addEventListener("load",w),d.addEventListener("error",()=>R(new Error(`Unable to preload CSS for ${s}`)))})}))}function l(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return r.then(i=>{for(const c of i||[])c.status==="rejected"&&l(c.reason);return t().catch(l)})},q="cinenext_livepeer_api_key",O="https://livepeer.studio/api",P=document.querySelector("#api-key"),M=document.querySelector("#save-key"),H=document.querySelector("#connect-api"),z=document.querySelector("#clear-key"),_=document.querySelector("#api-status"),b=document.querySelector("#upload-form"),V=document.querySelector("#upload-name"),G=document.querySelector("#upload-file"),Y=document.querySelector("#upload-description"),Q=document.querySelector("#upload-category"),W=document.querySelector("#upload-unlock-type"),X=document.querySelector("#upload-nft-address"),E=document.querySelector("#upload-price"),Z=document.querySelector("#upload-encrypted"),ee=document.querySelector("#upload-metadata-json"),te=document.querySelector("#upload-reset"),B=document.querySelector("#upload-progress"),U=document.querySelector("#search-input"),ne=document.querySelector("#refresh-list"),j=document.querySelector("#video-table"),k=document.querySelector("#video-tbody"),I=document.querySelector("#empty-state"),x=document.querySelector("#edit-panel"),re=document.querySelector("#edit-form"),C=document.querySelector("#edit-id"),T=document.querySelector("#edit-name"),L=document.querySelector("#edit-metadata-json"),oe=document.querySelector("#edit-cancel"),g=document.querySelector("#toast");let f=[];const A=(e,t)=>{try{return JSON.parse(e)}catch{return t}},a=(e,t=!1)=>{g.textContent=e,g.style.color=t?"#ff9d9d":"#89d6a8",window.setTimeout(()=>{g.textContent===e&&(g.textContent="")},2600)},$=()=>P.value.trim(),p=(e,t=!1)=>{_.textContent=e,_.style.color=t?"#ff9d9d":"#97a2bb"},ce=e=>{if(!e)return"-";const t=new Date(e);return Number.isNaN(t.getTime())?"-":`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},se=e=>{if(!e)return{};if(typeof e=="string"){const t=A(e,{});return t&&typeof t=="object"&&!Array.isArray(t)?t:{}}return typeof e=="object"&&!Array.isArray(e)?e:{}},ie=e=>{var t;return e.playbackId?String(e.playbackId):Array.isArray(e.playbackIds)&&((t=e.playbackIds[0])!=null&&t.id)?String(e.playbackIds[0].id):Array.isArray(e.playbackIds)&&typeof e.playbackIds[0]=="string"?e.playbackIds[0]:""},ue=e=>{var n;const t=se(e.metadata);return{id:String(e.id||""),name:String(e.name||"未命名资源"),status:String(((n=e.status)==null?void 0:n.phase)||e.status||"unknown"),createdAt:e.createdAt||e.created_at||"",playbackId:ie(e),metadata:t,raw:e}},N=async(e,{method:t="GET",body:n}={})=>{const o=$();if(!o)throw new Error("请先填写 API Key");const r={Authorization:`Bearer ${o}`};n&&(r["Content-Type"]="application/json");const l=await fetch(`${O}${e}`,{method:t,headers:r,body:n?JSON.stringify(n):void 0}),i=await l.text(),c=A(i,null);if(!l.ok){const s=(c==null?void 0:c.error)||(c==null?void 0:c.message)||(c==null?void 0:c.details)||i||`请求失败（HTTP ${l.status}）`;throw new Error(String(s))}return c},ae=e=>{const t=new URLSearchParams;Object.entries(e).forEach(([o,r])=>{r==null||r===""||t.set(o,String(r))});const n=t.toString();return n?`?${n}`:""},de=e=>{var r,l,i;if(Array.isArray(e))return{items:e,nextCursor:"",hasNext:!1};const t=Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e==null?void 0:e.assets)?e.assets:Array.isArray(e==null?void 0:e.items)?e.items:[],n=(e==null?void 0:e.nextCursor)||(e==null?void 0:e.next_cursor)||((r=e==null?void 0:e.meta)==null?void 0:r.nextCursor)||((l=e==null?void 0:e.meta)==null?void 0:l.next_cursor)||"",o=!!(e!=null&&e.hasNextPage||e!=null&&e.hasNext||(i=e==null?void 0:e.meta)!=null&&i.hasNextPage||n);return{items:t,nextCursor:String(n||""),hasNext:o}},le=async()=>{const n=[];let o=1,r="";for(let c=0;c<50;c+=1){const s=ae({limit:100,page:o,cursor:r}),m=await N(`/asset${s}`),u=de(m);if(!u.items.length)break;if(n.push(...u.items),u.nextCursor){r=u.nextCursor,o+=1;continue}if(u.items.length<100||!u.hasNext)break;o+=1}const l=[],i=new Set;return n.forEach(c=>{const s=String((c==null?void 0:c.id)||"");!s||i.has(s)||(i.add(s),l.push(c))}),l},me=e=>{const t=[];return["unlockType","nftCollectionAddress","price","category"].forEach(o=>{(e==null?void 0:e[o])!==void 0&&(e==null?void 0:e[o])!==""&&t.push(`${o}: ${e[o]}`)}),t.length===0?"-":t.join(" | ")},y=(e,t=!1)=>{B.textContent=e,B.style.color=t?"#ff9d9d":"#97a2bb"},v=()=>{C.value="",T.value="",L.value="",x.hidden=!0},fe=()=>{const e=W.value==="nft"?"nft":"free",t={unlockType:e,category:Q.value.trim(),description:Y.value.trim(),nftCollectionAddress:e==="nft"?X.value.trim():"",price:String(E.value||"0.5").trim()},n=A(ee.value.trim()||"{}",null);if(n===null||typeof n!="object"||Array.isArray(n))throw new Error("额外 metadata 必须是 JSON 对象");return Object.entries(n).forEach(([o,r])=>{t[o]=r}),t},ye=async({file:e,name:t,metadata:n})=>{const o=$();if(!o)throw new Error("请先填写 API Key");const r=await J(()=>import("https://esm.sh/tus-js-client@4.3.1"),[]),l=r.default||r,i={filename:e.name,filetype:e.type||"video/mp4",name:t,encrypted:Z.checked?"true":"false"};return Object.entries(n).forEach(([c,s])=>{s!=null&&(i[c]=typeof s=="string"?s:JSON.stringify(s))}),new Promise((c,s)=>{const m=new l.Upload(e,{endpoint:`${O}/asset/upload/direct`,headers:{Authorization:`Bearer ${o}`},retryDelays:[0,1e3,3e3,5e3],metadata:i,onError:u=>{s(u instanceof Error?u:new Error("上传失败"))},onProgress:(u,d)=>{const w=d>0?(u/d*100).toFixed(1):"0.0";y(`上传中：${w}%`)},onSuccess:()=>{c({uploadUrl:m.url||""})}});m.start()})},h=()=>{const e=U.value.trim().toLowerCase(),t=f.filter(n=>e?n.name.toLowerCase().includes(e)||n.playbackId.toLowerCase().includes(e):!0);if(k.innerHTML="",t.length===0){j.hidden=!0,I.hidden=!1,I.textContent=f.length===0?"当前没有资产，请先连接并上传。":"没有匹配的搜索结果。";return}j.hidden=!1,I.hidden=!0,t.forEach(n=>{const o=document.createElement("tr"),r=document.createElement("td");r.textContent=n.name;const l=document.createElement("td");l.textContent=n.status;const i=document.createElement("td");i.textContent=n.playbackId||"-";const c=document.createElement("td");c.textContent=ce(n.createdAt);const s=document.createElement("td");s.textContent=me(n.metadata);const m=document.createElement("td");m.className="actions-cell";const u=document.createElement("button");u.type="button",u.className="secondary",u.dataset.action="edit",u.dataset.id=n.id,u.textContent="编辑";const d=document.createElement("button");d.type="button",d.className="danger",d.dataset.action="delete",d.dataset.id=n.id,d.textContent="删除",m.append(u,d),o.append(r,l,i,c,s,m),k.appendChild(o)})},S=async(e=!0)=>{f=(await le()).map(ue),h(),e&&a(`已拉取 ${f.length} 条资产`),p(`连接成功，当前资产数量：${f.length}`)},pe=e=>{const t=f.find(n=>n.id===e);if(!t){a("未找到该资产",!0);return}C.value=t.id,T.value=t.name,L.value=JSON.stringify(t.metadata||{},null,2),x.hidden=!1,x.scrollIntoView({behavior:"smooth",block:"start"})},he=async e=>{const t=f.find(r=>r.id===e),n=t?`确认删除资源：${t.name}？`:"确认删除该资源？";window.confirm(n)&&(await N(`/asset/${encodeURIComponent(e)}`,{method:"DELETE"}),f=f.filter(r=>r.id!==e),h(),v(),a("已删除资源"))};M.addEventListener("click",()=>{const e=$();if(!e){a("请先输入 API Key",!0);return}localStorage.setItem(q,e),a("API Key 已保存到浏览器本地")});z.addEventListener("click",()=>{localStorage.removeItem(q),P.value="",f=[],h(),v(),p("API Key 已清除。"),a("已清除 API Key")});H.addEventListener("click",async()=>{try{p("连接中..."),await S()}catch(e){p("连接失败，请检查 API Key 或网络。",!0),a(e instanceof Error?e.message:"连接失败",!0)}});ne.addEventListener("click",async()=>{try{await S()}catch(e){a(e instanceof Error?e.message:"刷新失败",!0)}});U.addEventListener("input",()=>{h()});b.addEventListener("submit",async e=>{var o;e.preventDefault();const t=(o=G.files)==null?void 0:o[0];if(!t){a("请选择视频文件",!0);return}const n=V.value.trim();if(!n){a("请输入资源名称",!0);return}try{const r=fe();y("初始化上传..."),await ye({file:t,name:n,metadata:r}),y("上传完成，正在等待 Livepeer 处理..."),a("上传成功，请稍等后刷新列表"),b.reset(),E.value="0.5",window.setTimeout(async()=>{try{await S(!1),y("已刷新列表。")}catch{y("上传成功，自动刷新失败，请手动点击“刷新列表”。",!0)}},1800)}catch(r){y("上传失败。",!0),a(r instanceof Error?r.message:"上传失败",!0)}});te.addEventListener("click",()=>{b.reset(),E.value="0.5",y("已清空上传表单。")});k.addEventListener("click",async e=>{const t=e.target;if(!(t instanceof HTMLElement))return;const{action:n,id:o}=t.dataset;if(!(!n||!o))try{if(n==="edit"){pe(o);return}n==="delete"&&await he(o)}catch(r){a(r instanceof Error?r.message:"操作失败",!0)}});oe.addEventListener("click",()=>{v()});re.addEventListener("submit",async e=>{e.preventDefault();const t=C.value.trim();if(!t){a("缺少 asset id",!0);return}const n=T.value.trim();if(!n){a("资源名称不能为空",!0);return}const o=A(L.value.trim()||"{}",null);if(o===null||typeof o!="object"||Array.isArray(o)){a("metadata 必须是 JSON 对象",!0);return}try{await N(`/asset/${encodeURIComponent(t)}`,{method:"PATCH",body:{name:n,metadata:o}}),a("已保存修改"),v(),await S(!1)}catch(r){a(r instanceof Error?r.message:"保存失败",!0)}});const Se=async()=>{const e=localStorage.getItem(q)||"";if(P.value=e,E.value="0.5",!e){p("尚未连接。"),h();return}p("检测到本地 API Key，尝试自动连接...");try{await S(!1),a("已自动连接 Livepeer")}catch{p("自动连接失败，请检查 API Key。",!0)}};Se();
//# sourceMappingURL=admin-pJzN7nLi.js.map
